\usepackage[english]{babel}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{amssymb,amsmath}
\usepackage[english]{cleveref}
\usepackage{geometry}
\usepackage{titling}
\usepackage[inline]{enumitem}
\usepackage{setspace}
\usepackage{fancyhdr}
\usepackage{environ}

\fancypagestyle{plain}{
    \fancyhf{}
    \fancyfoot[RE,LO]{\leftmark}
    \fancyfoot[LE,RO]{\thepage}
    \renewcommand{\footrulewidth}{1pt}
}

\fancypagestyle{fancy}{
    \fancyhf{}
    \fancyhead[CE,CO]{\rightmark}
    \fancyfoot[RE,LO]{\leftmark}
    \fancyfoot[LE,RO]{\thepage}
    \renewcommand{\headrulewidth}{1pt}
    \renewcommand{\footrulewidth}{1pt}
    \setlength{\headheight}{14.49998pt}
    \addtolength{\topmargin}{-2.49998pt}
}

\pagestyle{fancy}

\newcommand{\acknowledgementsname}{Acknowledgements}

\newcommand{\school}[1]{\def\theschool{#1}}
\newcommand{\programme}[1]{\def\theprogramme{#1}}
\newcommand{\subject}[1]{\def\thesubject{#1}}
\newcommand{\cosupervisor}[1]{\def\thecosupervisor{#1}}
\newcommand{\morecosupervisor}[1]{\def\themorecosupervisor{#1}}
\newcommand{\supervisor}[1]{\def\thesupervisor{#1}}
\newcommand{\session}[1]{\def\thesession{#1}}
\newcommand{\academicyear}[1]{\def\theacademicyear{#1}}
\newcommand{\fig}[2]{
    \begin{figure}[htbp]
        \centering
        \includegraphics[width=.8\linewidth]{figures/#1}
        \caption{#2}
        \label{fig:#1}
    \end{figure}
}
\NewEnviron{diagram}[2]{
    \begin{figure}[htbp]
        \centering
        \begin{tikzpicture}[
            node distance=2.5cm,
            block/.style={rectangle, draw, fill=blue!10, text width=6em, text centered, rounded corners, minimum height=3em, font=\sffamily\small},
            cloud/.style={draw, ellipse, fill=red!10, node distance=3cm, minimum height=2em, font=\sffamily\small},
            arrow/.style={thick, ->, >=stealth}
        ]
            \BODY 
        \end{tikzpicture}
        \caption{\unexpanded{#2}} % Use \unexpanded here
        \label{fig:#1}
    \end{figure}
}

\newenvironment{abstract}{\chapter*{\centering\abstractname}\addcontentsline{toc}{chapter}{\abstractname}}{} 
\newenvironment{acknowledgements}{\chapter*{\acknowledgementsname}}{} 
\newenvironment{dedication}{\chapter*{}\begin{flushright}\itshape}{\normalfont\end{flushright}}
\newenvironment{inlinelist}{\begin{enumerate*}[label=\emph{(\roman{*})}]}{\end{enumerate*}}

\newcommand{\chapterWithoutNumber}[1]{\chapter*{#1}\addcontentsline{toc}{chapter}{#1}}

\let\oldbibliography\bibliography
\renewcommand{\bibliography}[1]{
    \cleardoublepage
    \phantomsection
    \addcontentsline{toc}{chapter}{\bibname}
    \oldbibliography{#1}
}

\def\themainlinespacing{1}
\newcommand{\mainlinespacing}[1]{\def\themainlinespacing{#1}}
\let\oldmainmatter\mainmatter
\renewcommand{\mainmatter}{
    \oldmainmatter
    % \onehalfspacing % https://tex.stackexchange.com/questions/30073/why-is-the-linespread-factor-as-it-is
    \setstretch{\themainlinespacing}
}

\newcommand{\frontispiece}{
    \newgeometry{margin=0.8in}
    \begin{titlepage}
        \centering
        \large
        \textbf{\theschool}
        \\
        \noindent\hrulefill
        \vspace{0.4cm}
        
        \Large
        \theprogramme

        \Huge
        \vspace{4cm}
        \textbf{
            \thetitle
        }
        
        \large
        \vspace{1cm}
        Thesis in:
        \\
        \textsc{\thesubject}

        \vspace{4cm}
        %
        \begin{minipage}[t]{0.64\textwidth}
            \begin{flushleft}
                \textit{Supervisor} 
                \\ 
                \textbf{\thesupervisor}
                \\
                \vspace{0.4cm}
                \ifdefined\thecosupervisor
                \ifdefined\themorecosupervisor
                \textit{Co-supervisors} 
                \\
                \textbf{\thecosupervisor}
                \\
                \textbf{\themorecosupervisor}
                \else
                \textit{Correlatore} 
                \\
                \textbf{\thecosupervisor}
                \fi
                \fi
            \end{flushleft}
        \end{minipage}
        %
        \begin{minipage}[t]{0.34\textwidth}
            \begin{flushright}
                \textit{Candidate} 
                \\ 
                \textbf{\theauthor}
            \end{flushright}
        \end{minipage}
        \\
        
        \vfill
        \noindent\hrulefill
        \vspace{0.3cm}
        \Large
        
        Graduation Session: \thesession
        \\
        Academic Year \theacademicyear
    \end{titlepage}
    \restoregeometry
}
